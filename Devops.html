<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Azure DevOps ‚Äî Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --azure:#0a66c2;
      --card-glass:#ffffff;
      --border-glass:rgba(0,0,0,0.06);
      --text:#0a1f3a;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Poppins, sans-serif;
      min-height:100vh;
      background:#f3f4f6;
      display:flex;
      justify-content:flex-start;
      align-items:flex-start;
      padding:32px 24px;
      color:var(--text);
    }
    .container{
      width:1100px;max-width:100%;
      display:grid;grid-template-columns:420px 1fr;
      gap:26px;padding:28px;
      background:var(--card-glass);
      border:1px solid var(--border-glass);
      border-radius:22px;
      box-shadow:0 22px 60px rgba(15,23,42,0.12);
      animation:fadeIn .5s both;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}}
    .left{
      padding:20px 20px 22px;border-radius:18px;
      background:#f9fafb;border:1px solid #e5e7eb;
      display:flex;flex-direction:column;
    }
    .brand{display:flex;gap:14px;margin-bottom:18px;align-items:center}
    .logo{
      width:60px;height:60px;border-radius:18px;
      background:#eef3ff;display:flex;align-items:center;justify-content:center;
      border:1px solid #d1d5db;
    }
    .logo svg{width:34px;height:34px}
    .title{font-size:22px;font-weight:700;margin-bottom:4px}
    .subtitle{font-size:14px;color:var(--muted);margin-bottom:14px}

    .btn{
      width:100%;padding:14px;margin-bottom:18px;
      background:var(--azure);border:none;border-radius:999px;
      font-weight:600;font-size:15px;color:white;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:.25s;
    }
    .btn:hover{transform:translateY(-2px)}
    .spinner{width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,0.35);border-top-color:white;
      animation:spin 1s linear infinite;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .signin-info{
      margin-top:4px;background:#f3f4ff;
      border:1px solid #e0e7ff;padding:16px;border-radius:14px;
      font-size:14px;color:var(--muted);
    }

    .right{
      padding:18px 20px;border-radius:18px;
      background:#f9fbff;border:1px solid #e5e7eb;
      display:none;flex-direction:column;gap:18px;
    }

    .topbar{display:flex;justify-content:space-between;align-items:center}
    .avatar{width:60px;height:60px;border-radius:18px;overflow:hidden;background:#e5e7eb}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{font-weight:700;font-size:18px}
    .muted{font-size:14px;color:var(--muted)}

    .cards{display:grid;grid-template-columns:1fr 1.1fr;gap:16px;margin-top:8px}
    .card{background:#ffffff;border:1px solid #e5e9ef;padding:18px;border-radius:16px}

    .org-list{list-style:none;margin-top:8px;padding-left:0}
    .org-list li{
      display:flex;gap:12px;padding:10px 12px;border-radius:12px;
      background:#eef2ff;border:1px solid #d4ddff;margin-bottom:8px;
    }

    .org-icon{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(180deg,#2563eb,#1d4ed8);
      display:flex;justify-content:center;align-items:center;color:white;
      font-weight:700;flex-shrink:0;
    }
    .org-main{flex:1;font-size:13px}
    .owner-pill{padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600;}
    .owner-yes{background:#dcfce7;color:#166534;}
    .owner-no{background:#fee2e2;color:#b91c1c;}
    .risk-badge{padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600;}
    .risk-low{background:#dcfce7;color:#166534;}
    .risk-medium{background:#fef3c7;color:#92400e;}
    .risk-high{background:#fee2e2;color:#b91c1c;}

    .action-buttons{display:flex;flex-direction:column;gap:4px;align-items:flex-end}
    .small-btn{padding:6px 10px;font-size:12px;border-radius:999px;cursor:pointer;border:none;}
    .small-btn.danger{background:#ef4444;color:white;}
    .small-btn.secondary{background:#475569;color:white;}

    .danger-btn{background:#ef4444 !important;}

    #orgStatusMsg{min-height:1.2em;font-size:13px}

  </style>
</head>
<body>

<div class="container">
  <!-- LEFT LOGIN PANEL -->
  <div class="left">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0A66C2" stroke-width="1.6">
          <path d="M3 12c0-3.9 3.6-7 8-7 3.2 0 5 1.8 6 3.1"/>
          <path d="M21 12c0 3.9-3.6 7-8 7-3.2 0-5-1.8-6-3.1"/>
        </svg>
      </div>
      <div>
        <div class="title">Azure DevOps Portal</div>
        <div class="subtitle">Secure sign-in to access dashboard</div>
      </div>
    </div>

    <button id="startBtn" class="btn">
      <span id="startText">Sign in with Microsoft</span>
      <span id="startSpinner" class="spinner hidden"></span>
    </button>

    <div class="signin-info">
      Use your Microsoft organizational email to sign in.
    </div>
  </div>

  <!-- RIGHT DASHBOARD -->
  <div class="right" id="dashboard">
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar"><img id="avatarImg" /></div>
        <div>
          <div class="name" id="displayName">--</div>
          <div class="muted" id="displayEmail">--</div>
        </div>
      </div>
      <button id="signOutTop" class="btn danger-btn">Logout</button>
    </div>

    <div class="cards">
      <div class="card">
        <h3>Profile</h3>
        <p><strong>Name:</strong> <span id="nameVal">-</span></p>
        <p><strong>Email:</strong> <span id="emailVal">-</span></p>
        <p><strong>ID:</strong> <span id="idVal">-</span></p>
      </div>

      <div class="card">
        <h3>Organizations</h3>
        <ul class="org-list" id="orgList"><li>No organizations loaded.</li></ul>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="deleteSelectedBtn" class="btn danger-btn">Delete selected</button>
          <button id="refreshOrgsBtn" class="btn" style="background:#475569;">Refresh</button>
        </div>

        <p id="orgStatusMsg" class="muted" style="margin-top:6px;"></p>
      </div>
    </div>
  </div>
</div>

<script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const CLIENT_ID = "d3fa20a5-4696-48a1-b622-4e2dab8b6ea0";
const REDIRECT_URI = "https://trajak.github.io/azure-devops-login/Devops.html";

const msalConfig = {
  auth:{ clientId:CLIENT_ID, authority:"https://login.microsoftonline.com/common", redirectUri:REDIRECT_URI },
  cache:{ cacheLocation:"localStorage", storeAuthStateInCookie:false }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);

const loginScopes = [
  "User.Read",
  "499b84ac-1321-427f-aa17-267ca6975798/.default"
];

/* ---------- UI ELEMENTS ---------- */
const startBtn = document.getElementById("startBtn");
const startSpinner = document.getElementById("startSpinner");
const startText = document.getElementById("startText");
const dashboard = document.getElementById("dashboard");
const avatarImg = document.getElementById("avatarImg");
const displayName = document.getElementById("displayName");
const displayEmail = document.getElementById("displayEmail");
const nameVal = document.getElementById("nameVal");
const emailVal = document.getElementById("emailVal");
const idVal = document.getElementById("idVal");
const orgList = document.getElementById("orgList");
const signOutTop = document.getElementById("signOutTop");
const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
const refreshOrgsBtn = document.getElementById("refreshOrgsBtn");
const orgStatusMsg = document.getElementById("orgStatusMsg");

/* ---------- STATE ---------- */
let lastOrgSnapshot = null;
let hasInitialSnapshot = false;

/* ---------- HELPERS ---------- */
function showSpinner(show){
  if(show){ startSpinner.classList.remove("hidden"); startText.textContent = "Signing in..."; }
  else { startSpinner.classList.add("hidden"); startText.textContent = "Sign in with Microsoft"; }
}
function showOrgStatus(message){ orgStatusMsg.textContent = message || ""; }

function formatDate(dateString){
  if(!dateString) return "Unknown";
  const d = new Date(dateString);
  return isNaN(d.getTime()) ? "Unknown" : d.toLocaleDateString();
}

/* ---------- RISK ---------- */
function assessRisk(org){
  const name = (org.accountName || "").toLowerCase();
  const updated = org.lastUpdatedDate ? new Date(org.lastUpdatedDate)
               : org.createdDate ? new Date(org.createdDate) : null;
  let score=0, reasons=[];
  if(updated && !isNaN(updated.getTime())){
    const days = (Date.now() - updated)/864e5;
    if(days <=30){ score+=2; reasons.push("recent"); }
    else if(days <=180){ score+=1; reasons.push("active <6m"); }
    else { score-=1; reasons.push("inactive long"); }
  }
  if(name.includes("prod")||name.includes("live")||name.includes("retail")){ score+=2; reasons.push("production term"); }
  if(name.includes("test")||name.includes("demo")||name.includes("sandbox")||name.includes("poc")){ score-=2; reasons.push("non-prod name"); }

  return score>=3? {level:"High",reason:reasons.join(",")}
       : score>=1? {level:"Medium",reason:reasons.join(",")}
       : {level:"Low",reason:reasons.join(",")};
}

/* ---------- URL Normalizer ---------- */
function getDeleteBaseUrl(name, uri){
  let base="";
  if(uri && uri.trim()){
    uri=uri.trim();
    if(uri.includes(".visualstudio.com")){
      const m = uri.match(/https:\/\/([^.]+)\.visualstudio\.com/i);
      if(m && m[1]) base=`https://dev.azure.com/${m[1]}`;
    } else if(uri.includes("vssps.dev.azure.com")){
      base = uri.replace("vssps.dev.azure.com","dev.azure.com");
    } else if(uri.includes("dev.azure.com")){
      base = uri;
    }
  }
  if(!base) base = `https://dev.azure.com/${name}`;
  return base.replace(/\/$/,"");
}
function getDeleteLink(name, uri){
  return getDeleteBaseUrl(name, uri) + "/_settings/organization?delete=true";
}

/* ---------- DELETE CONFIRM ---------- */
function confirmOrgName(name){
  const typed = prompt(`To confirm deletion, type this organization name:\n\n${name}`);
  return typed && typed.trim().toLowerCase() === name.toLowerCase();
}

function handleDeleteClick(name, uri, risk, lastActivity){
  if(!confirmOrgName(name)){ alert("Name mismatch. Deletion cancelled."); return; }
  showOrgStatus(`‚è≥ Delete page opened for "${name}". Complete deletion in Azure DevOps, then press Refresh.`);
  window.open(getDeleteLink(name, uri), "_blank");
}

/* ---------- TOKEN ---------- */
async function getToken(account){
  try{ return await msalInstance.acquireTokenSilent({account, scopes:loginScopes}); }
  catch{ return await msalInstance.acquireTokenPopup({account, scopes:loginScopes}); }
}

/* ---------- MAIN LOAD ---------- */
async function signInAndLoad(isRefresh=false){
  try{
    showSpinner(true);
    let account = msalInstance.getAllAccounts()[0];
    if(!account){
      const login = await msalInstance.loginPopup({scopes:loginScopes});
      account = login.account;
    }
    const tokenResp = await getToken(account);
    const adoToken = tokenResp.accessToken;

    const profileRes = await fetch(
      "https://app.vssps.visualstudio.com/_apis/profile/profiles/me?api-version=7.0",
      {headers:{Authorization:`Bearer ${adoToken}`}}
    );
    const profile = await profileRes.json();

    avatarImg.src = profile._links?.avatar?.href
      || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.displayName||"U")}`;
    displayName.textContent = nameVal.textContent = profile.displayName || "Unknown";
    displayEmail.textContent = emailVal.textContent = profile.emailAddress || "";
    idVal.textContent = profile.id || "-";

    const memberRes = await fetch(
      `https://app.vssps.visualstudio.com/_apis/accounts?memberId=${profile.id}&api-version=7.0`,
      {headers:{Authorization:`Bearer ${adoToken}`}}
    );
    const memberData = await memberRes.json();

    const ownerRes = await fetch(
      `https://app.vssps.visualstudio.com/_apis/accounts?ownerId=${profile.id}&api-version=7.0`,
      {headers:{Authorization:`Bearer ${adoToken}`}}
    );
    const ownerData = await ownerRes.json();
    const ownerIds = new Set((ownerData.value || []).map(o=>o.accountId));

    orgList.innerHTML = "";
    const currentSnapshot = {};

    if(memberData.value?.length){
      for(const org of memberData.value){
        const isOwner = ownerIds.has(org.accountId);
        const li = document.createElement("li");

        const cb = document.createElement("input");
        cb.type="checkbox"; cb.className="org-select";
        cb.dataset.orgName = org.accountName||"";
        cb.dataset.orgUri = org.accountUri||"";

        const icon=document.createElement("div");
        icon.className="org-icon";
        icon.textContent = (org.accountName||"O").charAt(0).toUpperCase();

        const lastActivity = formatDate(org.lastUpdatedDate||org.createdDate);
        const risk = assessRisk(org);

        const main=document.createElement("div");
        main.className="org-main";
        main.innerHTML = `
          <strong>${org.accountName}</strong><br/>
          <span class="muted">${org.accountUri||""}</span><br/>
          <span class="muted small">Last activity: <b>${lastActivity}</b></span><br/>
          <span class="muted small">Risk:
            <span class="risk-badge risk-${risk.level.toLowerCase()}">${risk.level}</span>
          </span><br/>
          <span class="owner-pill ${isOwner?'owner-yes':'owner-no'}">
            ${isOwner?'Owner':'Not Owner'}
          </span>
        `;

        const actions=document.createElement("div");
        actions.className="action-buttons";

        const del=document.createElement("button");
        del.className="small-btn danger";
        del.textContent="Delete";
        del.onclick=()=>handleDeleteClick(
           org.accountName, org.accountUri,
           `${risk.level} (${risk.reason})`,
           lastActivity
        );

        const linkBtn=document.createElement("button");
        linkBtn.className="small-btn secondary";
        linkBtn.textContent="Copy Link";
        linkBtn.onclick=()=>navigator.clipboard.writeText(getDeleteLink(org.accountName, org.accountUri));

        if(!isOwner){
          cb.disabled=true;
          cb.title="You are not the owner";
        } else {
          actions.append(del, linkBtn);
        }

        li.append(cb, icon, main);
        if(isOwner) li.append(actions);
        orgList.append(li);

        currentSnapshot[org.accountId] = {
          name: org.accountName||"",
          lastActivity,
          wasOwner: isOwner
        };
      }
    } else {
      orgList.innerHTML="<li>No organizations found.</li>";
    }

    /* detect deletion on refresh */
    if(isRefresh && hasInitialSnapshot && lastOrgSnapshot){
      const deleted=[];
      for(const id in lastOrgSnapshot){
        if(!currentSnapshot[id] && lastOrgSnapshot[id].wasOwner){
          deleted.push(lastOrgSnapshot[id]);
        }
      }
      if(deleted.length){
        showOrgStatus(`üóë Organization "${deleted[0].name}" was removed successfully.`);
      } else {
        showOrgStatus("‚Ñπ No deleted organizations detected yet.");
      }
    } else {
      showOrgStatus("");
    }

    lastOrgSnapshot=currentSnapshot;
    hasInitialSnapshot=true;

    dashboard.style.display="flex";
    showSpinner(false);

  }catch(err){
    console.error(err);
    showSpinner(false);
    alert("Sign-in or load failed. Check console.");
  }
}

/* ---------- LOGOUT ---------- */
async function signOut(){
  try{ await msalInstance.logoutPopup({postLogoutRedirectUri:REDIRECT_URI}); }
  catch{}
  location.reload();
}

/* ---------- EVENTS ---------- */
startBtn.onclick = ()=>signInAndLoad(false);
signOutTop.onclick = signOut;
refreshOrgsBtn.onclick = ()=>{showOrgStatus("üîÑ Checking..."); signInAndLoad(true);};
deleteSelectedBtn.onclick = ()=>{
  const selected=[...document.querySelectorAll(".org-select:checked")];
  if(!selected.length) return alert("Select at least one organization.");
  const list=selected.map(x=>"- "+x.dataset.orgName).join("\n");
  if(!confirm("This opens delete pages in new tabs:\n\n"+list+"\n\nContinue?")) return;
  selected.forEach(cb=>{
    if(confirmOrgName(cb.dataset.orgName))
      window.open(getDeleteLink(cb.dataset.orgName, cb.dataset.orgUri),"_blank");
  });
  showOrgStatus("‚è≥ Delete pages opened. Complete deletion and press Refresh.");
};
</script>

</body>
</html>

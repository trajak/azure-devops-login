<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Azure DevOps â€” Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --azure:#0a66c2;
      --card-glass:#ffffff;
      --border-glass:rgba(0,0,0,0.06);
      --text:#0a1f3a;
      --muted:#6b7280;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:Poppins, sans-serif;
      min-height:100vh;
      background:#f3f4f6;
      display:flex;
      justify-content:flex-start;   /* move container left */
      align-items:flex-start;       /* move up */
      padding:32px 24px;
      color:var(--text);
    }

    .container{
      width:1100px;
      max-width:100%;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:26px;
      padding:28px;
      background:var(--card-glass);
      border:1px solid var(--border-glass);
      border-radius:22px;
      box-shadow:0 22px 60px rgba(15,23,42,0.12);
      animation:fadeIn .5s both;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}}

    /* LEFT LOGIN PANEL */
    .left{
      padding:20px 20px 22px;
      border-radius:18px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }

    .brand{display:flex;gap:14px;margin-bottom:18px;align-items:center}
    .logo{
      width:60px;height:60px;border-radius:18px;
      background:#eef3ff;
      display:flex;align-items:center;justify-content:center;
      border:1px solid #d1d5db;
    }
    .logo svg{width:34px;height:34px}
    .title{font-size:22px;font-weight:700;margin-bottom:4px}
    .subtitle{font-size:14px;color:var(--muted);margin-bottom:14px}

    .btn{
      width:100%;padding:14px;margin-bottom:18px;
      background:var(--azure);border:none;border-radius:999px;
      font-weight:600;font-size:15px;
      display:flex;align-items:center;justify-content:center;
      color:white;cursor:pointer;
      box-shadow:0 8px 18px rgba(37,99,235,0.45);
      transition:.25s;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(37,99,235,0.55)}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,0.35);border-top-color:white;
      animation:spin 1s linear infinite;margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .signin-info{
      margin-top:4px;
      background:#f3f4ff;
      border:1px solid #e0e7ff;
      padding:16px;border-radius:14px;
      font-size:14px;color:var(--muted);
    }

    /* RIGHT DASHBOARD */
    .right{
      padding:18px 20px;
      border-radius:18px;
      background:#f9fbff;
      border:1px solid #e5e7eb;
      display:none;
      flex-direction:column;
      gap:18px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:4px;
    }
    .avatar{width:60px;height:60px;border-radius:18px;overflow:hidden;background:#e5e7eb}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{font-weight:700;font-size:18px}
    .muted{font-size:14px;color:var(--muted)}

    .cards{
      display:grid;
      grid-template-columns:1fr 1.1fr;
      gap:16px;
      margin-top:8px;
    }

    .card{
      background:#ffffff;
      border:1px solid #e5e9ef;
      padding:18px 18px 16px;
      border-radius:16px;
      box-shadow:0 10px 26px rgba(15,23,42,0.05);
    }
    .card h3{margin-bottom:10px}

    .org-list{list-style:none;margin-top:8px;padding-left:0}
    .org-list li{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#eef2ff;
      border:1px solid #d4ddff;
      margin-bottom:8px;
    }

    .org-icon{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(180deg,#2563eb,#1d4ed8);
      display:flex;justify-content:center;align-items:center;
      color:white;font-weight:700;flex-shrink:0;
    }

    .org-main{flex:1;}

    .org-main strong{font-size:14px}
    .org-main .line{font-size:13px;margin-top:2px;}
    .owner-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      margin-top:4px;
    }
    .owner-yes{background:#dcfce7;color:#166534;}
    .owner-no{background:#fee2e2;color:#b91c1c;}

    .risk-badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .risk-low{background:#dcfce7;color:#166534;}
    .risk-medium{background:#fef3c7;color:#92400e;}
    .risk-high{background:#fee2e2;color:#b91c1c;}

    .small-btn{
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      white-space:nowrap;
      margin-top:4px;
    }
    .small-btn.danger{background:#ef4444;color:white;}
    .small-btn.danger:hover{background:#dc2626;}

    .danger-btn{
      background:#ef4444 !important;
      box-shadow:none !important;
      border-radius:999px;
    }
    .danger-btn:hover{background:#dc2626 !important;}

    .small{font-size:12px;}
    .hidden{display:none;}

    @media (max-width:1000px){
      .container{
        grid-template-columns:1fr;
      }
      body{
        justify-content:center;
        padding:16px;
      }
      .cards{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- LEFT PANEL -->
    <div class="left">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0A66C2" stroke-width="1.6">
            <path d="M3 12c0-3.9 3.6-7 8-7 3.2 0 5 1.8 6 3.1"/>
            <path d="M21 12c0 3.9-3.6 7-8 7-3.2 0-5-1.8-6-3.1"/>
          </svg>
        </div>
        <div>
          <div class="title">Azure DevOps Portal</div>
          <div class="subtitle">Secure sign-in to access dashboard</div>
        </div>
      </div>

      <button id="startBtn" class="btn">
        <span id="startText">Sign in with Microsoft</span>
        <span id="startSpinner" class="spinner hidden"></span>
      </button>

      <div class="signin-info">
        Use your Microsoft organizational Email to sign in. Your DevOps dashboard will load instantly.
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right" id="dashboard">
      <div class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="avatar"><img id="avatarImg" alt="avatar" /></div>
          <div>
            <div class="name" id="displayName">--</div>
            <div class="muted" id="displayEmail">--</div>
          </div>
        </div>
        <button id="signOutTop" class="btn" style="background:#ef4444;box-shadow:none">Logout</button>
      </div>

      <div class="cards">
        <div class="card">
          <h3>Profile</h3>
          <p><strong>Name:</strong> <span id="nameVal">-</span></p>
          <p><strong>Email:</strong> <span id="emailVal">-</span></p>
          <p><strong>ID:</strong> <span id="idVal">-</span></p>
        </div>

        <div class="card">
          <h3>Organizations</h3>
          <ul class="org-list" id="orgList">
            <li>No organizations loaded.</li>
          </ul>
          <button id="deleteSelectedBtn" class="btn danger-btn" style="margin-top:10px;">
            Delete selected organizations
          </button>
          <p class="muted small" style="margin-top:6px;">
            * Only Owners can delete. This opens the Azure DevOps delete page in a new tab.  
            You must confirm deletion and type the org name in Azure DevOps.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <script>
    const CLIENT_ID = "d3fa20a5-4696-48a1-b622-4e2dab8b6ea0";
    const REDIRECT_URI = "https://trajak.github.io/azure-devops-login/Devops.html";

    const msalConfig = {
      auth: {
        clientId: CLIENT_ID,
        authority: "https://login.microsoftonline.com/common",
        redirectUri: REDIRECT_URI
      },
      cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const startBtn = document.getElementById("startBtn");
    const startSpinner = document.getElementById("startSpinner");
    const startText = document.getElementById("startText");
    const dashboard = document.getElementById("dashboard");
    const avatarImg = document.getElementById("avatarImg");
    const displayName = document.getElementById("displayName");
    const displayEmail = document.getElementById("displayEmail");
    const nameVal = document.getElementById("nameVal");
    const emailVal = document.getElementById("emailVal");
    const idVal = document.getElementById("idVal");
    const orgList = document.getElementById("orgList");
    const signOutTop = document.getElementById("signOutTop");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");

    function showSpinner(show){
      if(show){
        startSpinner.classList.remove("hidden");
        startText.textContent = "Signing in...";
      } else {
        startSpinner.classList.add("hidden");
        startText.textContent = "Sign in with Microsoft";
      }
    }

    function openDeleteSettings(name, uri){
      const base = (uri && uri.trim().length) ? uri : `https://dev.azure.com/${name}`;
      window.open(base.replace(/\/$/,'') + "/_settings/organization", "_blank");
    }

    function formatDate(dateString){
      if(!dateString) return "Unknown";
      const d = new Date(dateString);
      if(isNaN(d.getTime())) return "Unknown";
      return d.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
    }

    function assessRisk(org){
      const name = (org.accountName || "").toLowerCase();
      const updated = org.lastUpdatedDate ? new Date(org.lastUpdatedDate) :
                       (org.createdDate ? new Date(org.createdDate) : null);
      let days = null;
      if(updated && !isNaN(updated.getTime())){
        const now = new Date();
        days = Math.round((now - updated)/(1000*60*60*24));
      }

      let score = 0;
      const reasons = [];

      if(days !== null){
        if(days <= 30){ score += 2; reasons.push("recently active"); }
        else if(days <= 180){ score += 1; reasons.push("active in last 6 months"); }
        else { score -= 1; reasons.push("inactive for a long time"); }
      }

      if(name.includes("prod") || name.includes("live") || name.includes("retail")){
        score += 2; reasons.push("name suggests production");
      }
      if(name.includes("ccoE".toLowerCase()) || name.includes("core")){
        score += 1; reasons.push("core/CoE related");
      }
      if(name.includes("test") || name.includes("demo") || name.includes("sandbox") || name.includes("poc")){
        score -= 2; reasons.push("name suggests test/demo");
      }

      let level = "Low";
      if(score >= 3) level = "High";
      else if(score >= 1) level = "Medium";

      return { level, reason: reasons.join(", ") || "no strong signals" };
    }

    function confirmOrgName(name, extraInfo){
      const msg = `To confirm deletion of organization:\n\n  ${name}\n\n`
        + (extraInfo ? extraInfo + "\n\n" : "")
        + `Type the organization name exactly to continue.`;
      const typed = prompt(msg);
      if(!typed) return false;
      return typed.trim().toLowerCase() === name.toLowerCase();
    }

    function handleDeleteClick(name, uri, riskLabel, lastActivity){
      const info = `Risk: ${riskLabel}\nLast activity: ${lastActivity}`;
      if(!confirmOrgName(name, info)){
        alert("Name mismatch. Deletion cancelled.");
        return;
      }
      openDeleteSettings(name, uri);
    }

    function deleteSelectedOrgs(){
      const selected = [...document.querySelectorAll(".org-select:checked")];
      if(!selected.length){
        alert("Select at least one organization.");
        return;
      }

      const orgNames = selected.map(cb => cb.dataset.orgName);
      const listText = orgNames.join("\n  - ");
      const ok = confirm(
        "This will open the Azure DevOps organization settings page in new tabs for:\n\n  - "
        + listText +
        "\n\nYou must confirm deletion for each organization in Azure DevOps.\n\nContinue?"
      );
      if(!ok) return;

      selected.forEach(cb => {
        const name = cb.dataset.orgName;
        const uri = cb.dataset.orgUri;
        if(!confirmOrgName(name)){
          alert(`Skipped ${name} (name did not match).`);
          return;
        }
        openDeleteSettings(name, uri);
      });
    }

    async function signInAndLoad(){
      try{
        showSpinner(true);
        const login = await msalInstance.loginPopup({ scopes:["User.Read"] });

        const tokenResp = await msalInstance.acquireTokenSilent({
          account: login.account,
          scopes:["499b84ac-1321-427f-aa17-267ca6975798/.default"]
        }).catch(() => msalInstance.acquireTokenPopup({
          account: login.account,
          scopes:["499b84ac-1321-427f-aa17-267ca6975798/.default"]
        }));
        const token = tokenResp.accessToken;

        // Profile
        const profileRes = await fetch(
          "https://app.vssps.visualstudio.com/_apis/profile/profiles/me?api-version=7.0",
          { headers:{Authorization:`Bearer ${token}`} }
        );
        const profile = await profileRes.json();

        avatarImg.src = profile._links?.avatar?.href ||
          "https://ui-avatars.com/api/?name=" + encodeURIComponent(profile.displayName || "U") + "&background=e5e7eb&color=111827";
        displayName.textContent = profile.displayName || "Unknown";
        displayEmail.textContent = profile.emailAddress || "";
        nameVal.textContent = profile.displayName || "-";
        emailVal.textContent = profile.emailAddress || "-";
        idVal.textContent = profile.id || "-";

        // All orgs where user is member
        const memberRes = await fetch(
          `https://app.vssps.visualstudio.com/_apis/accounts?memberId=${profile.id}&api-version=7.0`,
          { headers:{Authorization:`Bearer ${token}`} }
        );
        const memberData = await memberRes.json();

        // Orgs where user is owner (this is the key for Owner detection)
        const ownerRes = await fetch(
          `https://app.vssps.visualstudio.com/_apis/accounts?ownerId=${profile.id}&api-version=7.0`,
          { headers:{Authorization:`Bearer ${token}`} }
        );
        const ownerData = await ownerRes.json();
        const ownerIds = new Set((ownerData.value || []).map(o => o.accountId));

        orgList.innerHTML = "";

        if(memberData.value && memberData.value.length){
          for(const org of memberData.value){
            const isOwner = ownerIds.has(org.accountId);
            const li = document.createElement("li");

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.className = "org-select";
            cb.dataset.orgName = org.accountName || "";
            cb.dataset.orgUri = org.accountUri || "";

            const icon = document.createElement("div");
            icon.className = "org-icon";
            icon.textContent = (org.accountName || "O").charAt(0).toUpperCase();

            const main = document.createElement("div");
            main.className = "org-main";

            const lastActivityDate = formatDate(org.lastUpdatedDate || org.createdDate);
            const risk = assessRisk(org);

            main.innerHTML = `
              <strong>${org.accountName}</strong>
              <div class="line muted">${org.accountUri || ""}</div>
              <div class="line muted small">Last activity: <strong>${lastActivityDate}</strong></div>
              <div class="line muted small">
                Risk:
                <span class="risk-badge risk-${risk.level.toLowerCase()}" title="${risk.reason}">
                  ${risk.level}
                </span>
              </div>
              <div class="line">
                <span class="owner-pill ${isOwner ? "owner-yes" : "owner-no"}">
                  ${isOwner ? "Owner" : "Not Owner"}
                </span>
              </div>
            `;

            const del = document.createElement("button");
            del.className = "small-btn danger";
            del.textContent = "Delete";
            del.style.display = isOwner ? "inline-block" : "none";
            del.addEventListener("click", () => {
              handleDeleteClick(org.accountName, org.accountUri, `${risk.level} (${risk.reason})`, lastActivityDate);
            });

            if(!isOwner){
              cb.disabled = true;
              cb.title = "You are not the owner of this organization.";
            }

            li.append(cb, icon, main, del);
            orgList.appendChild(li);
          }
        } else {
          orgList.innerHTML = "<li>No organizations found.</li>";
        }

        dashboard.style.display = "flex";
        showSpinner(false);

      }catch(err){
        console.error(err);
        showSpinner(false);
        alert("Sign-in failed. See console for details.");
      }
    }

    async function signOut(){
      try{
        await msalInstance.logoutPopup({ postLogoutRedirectUri: REDIRECT_URI });
      }catch(e){ console.warn("logout popup error", e); }
      dashboard.style.display = "none";
      avatarImg.src = "";
      displayName.textContent = "--";
      displayEmail.textContent = "--";
      nameVal.textContent = "-";
      emailVal.textContent = "-";
      idVal.textContent = "-";
      orgList.innerHTML = "<li>No organizations loaded.</li>";
    }

    startBtn.addEventListener("click", signInAndLoad);
    signOutTop.addEventListener("click", signOut);
    deleteSelectedBtn.addEventListener("click", deleteSelectedOrgs);
  </script>
</body>
</html>
